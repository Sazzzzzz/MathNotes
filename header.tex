% This preamble is heavily inspired by Soham Chatterjee's work in
% https://github.com/sohamch08/Eye-Candy-Lecture-Notes-Theme

% tex-fmt: off
% cSpell: disable
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PACKAGE IMPORTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{booktabs}  % 提供更专业的表格线条
% Provide support for minipage used in definition environment
\usepackage{varwidth}
\usepackage{array}     % 增强的表格功能
% Underline and strikethrough
\usepackage[normalem]{ulem}
\usepackage[dvipsnames]{xcolor}
\usepackage[most,many,breakable]{tcolorbox}
\usepackage{extarrows}
\usepackage{derivative}
\usepackage{tikz-cd}
% Make sure all math formulas are displayed in displaystyle
\usepackage{breqn}
% Some may argue that the use of displaystyle in inline formulas may
% break line spacing and make the document look ugly. However, I
% prefer to follow the choice of the textbook setting
\everymath{\displaystyle}
% For \mathscr
\usepackage{mathrsfs}
\usepackage{graphicx}
% Title and ToC format
\usepackage{titletoc,titlesec}
\usepackage{float}
\usepackage{tikz}
% For bold math symbols
\usepackage{bm}
\usepackage{mathtools} % For \coloneqq
\usepackage{hyperref}
\hypersetup{%
 colorlinks=true, linkcolor=mydoccolor!80, urlcolor=mydoccolor!80,
 citecolor=mydefinitfr!80!black,
 bookmarksnumbered=true,
 bookmarksopen=true
}
% Use verb inside other environments
\usepackage{fancyvrb}
\VerbatimFootnotes
\SaveVerb{smile}|:-)|
\SaveVerb{laugh}|:-D|
\SaveVerb{wink}|;-)|
\SaveVerb{sad}|:-(|
\SaveVerb{angry}|:-@|
\SaveVerb{confused}|:-S|
\SaveVerb{cool}|B-)|
\SaveVerb{cry}|:'-|
\SaveVerb{kiss}|:-*|
\SaveVerb{surprised}|:-o|
\SaveVerb{grin}|:-]|
\SaveVerb{naughty}|:P|
% \setCJKmainfont[BoldFont=SimHei,ItalicFont=FangSong,BoldItalicFont=LiSu]{SimSun}
% For cancel line
\usepackage{cancel}
% For code highlighting
\usepackage{listings}
\newfontfamily{\Cascadia}{Cascadia Code}
\lstset{language=Mathematica}
\lstset{basicstyle={\Cascadia\footnotesize},
    numbers=left,
    numberstyle=\tiny\color{gray},
    numbersep=5pt,
    breaklines=true,
    captionpos={t},
    frame={lines},
    rulecolor=\color{black},
    framerule=0.5pt,
    columns=flexible,
    tabsize=4
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Custom commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%================================
% PAGE SETUP
%================================

\renewcommand{\thesection}{\textbf{\chinese{section}}、\hspace{-1em}}
\renewcommand{\thesubsection}{\arabic{subsection}.\hspace{-0.3em}}
\renewcommand{\thesubsubsection}{\arabic{subsubsection}}
\catcode`\。=\active\newcommand{。}{．}
\ctexset{section={format={\Large\raggedright\bfseries}}}
%================================
% MATH COMMANDS
%==========================\hl{}===
\AtBeginDocument{%
\renewcommand\Re{\operatorname{Re}}
\renewcommand\Im{\operatorname{Im}}
}
\renewcommand{\i}{\mathrm{i}}
\newcommand{\e}{\mathrm{e}}
\renewcommand{\d}{\odif}

\newcommand{\R}{\mathbb{R}} % Real
\newcommand{\C}{\mathbb{C}} % Complex
\newcommand{\Z}{\mathbb{Z}} % Integer, from Zahlen, by David Hilbert
\newcommand{\Q}{\mathbb{Q}} % Rational, from Quotient
\newcommand{\N}{\mathbb{N}} % Natural, from Naturals

\newcommand{\abs}[1]{\left|#1\right|} % Absolute value

\newcommand{\placeholder}[1]{\mathrel{\phantom{#1}}} % Placeholder

%================================
% DOCUMENT SETUP
%================================

\newcommand\hl{\bgroup\markoverwith{\textcolor{yellow}{\rule[-.5ex]{2pt}{2.5ex}}}\ULon}

\newfontfamily\DancingScript{Dancing Script OT}
\newcommand{\Caffein}{\DancingScript{Caffein3}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% COLORS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definecolor{myclaimcolor}{RGB}{56, 140, 70}
\definecolor{mynoteolor}{RGB}{56, 140, 70}

% 配色设计原理 P27
% CMYK 90 65 10 45
\definecolor{mytheoremcolor}{RGB}{16,59,154}
% CMYK 0 100 65 40
\definecolor{mydefinitioncolor}{RGB}{169, 14, 69}
% CMYK 10 20 30 30
\definecolor{myquotecolor}{RGB}{161,143,125}

% 配色设计原理 P27
\definecolor{myproblemcolor}{RGB}{255,128,0}

\definecolor{mydoccolor}{RGB}{141,64,13}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TABLE OF CONTENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Let's just hope I won't use chapter more than 10 times
\usetikzlibrary{shapes, positioning}
\contentsmargin{0cm}
\titlecontents{chapter}[3.7pc]
{\addvspace{30pt}%
    \begin{tikzpicture}[remember picture, overlay]%
        \draw[fill=mydoccolor!60,draw=mydoccolor!60]
        (-7,-.1) rectangle (-0.6,.5);%
        \pgftext[left,x=-2.5cm,y=0.2cm]{\color{white}\Large\bfseries
        \thecontentslabel};%
\end{tikzpicture}\color{mydoccolor!60}\large\bfseries}%
{}
{}
{\;\titlerule\;\large\bfseries Page \thecontentspage
    \begin{tikzpicture}[remember picture, overlay]
        \draw[fill=mydoccolor!60,draw=mydoccolor!60]
        (2pt,0) rectangle (4,0.1pt);
\end{tikzpicture}}%
\titlecontents{section}[3.7pc]
{\addvspace{2pt}}
{\contentslabel[\textcolor{mydoccolor!80}\thecontentslabel]{2pc}}
{}
{\hfill\small \thecontentspage}
[]
\titlecontents{subsection}[2.7pc]
{\addvspace{-1pt}\small}
{\hspace*{2pc}\contentslabel[\textcolor{mydoccolor!80}\thecontentslabel]{1pc}}
{}
{\hfill\small \thecontentspage}
[]

%{\addvspace{-1pt}\small}
%{}
%{}
%{\ --- \small\thecontentspage}
%[ \textbullet\ ][]

\makeatletter
\renewcommand{\tableofcontents}{%
    \chapter*{%
        \vspace*{-80\p@}%
        \begin{tikzpicture}[remember picture, overlay]%
            \pgftext[right,x=15cm,y=0.2cm]{\color{mydoccolor!60}\Huge\bfseries
            \contentsname};%
            \draw[fill=mydoccolor!60,draw=mydoccolor!60] (13,-.75)
            rectangle (20,1);%
            \clip (13,-.75) rectangle (20,1);
            \pgftext[right,x=15cm,y=0.2cm]{\color{white}\Huge\bfseries
            \contentsname};%
    \end{tikzpicture}}%
\@starttoc{toc}}
\makeatother
%\titleformat{\chapter}[display]
%{\normalfont\Huge\bfseries}{\chaptertitlename\ \thechapter}{20pt}{\Huge}

\newcommand\colorlink[3]{\href{#2}{\color{#1}#3}}
\newcommand\colorurl[2]{{\color{#1}\url{#2}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% New environments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%! Caution: All environments with CAPITALIZED first letter
%! is for internal use only
\tcbuselibrary{theorems,skins,hooks}
%================================
% THEOREM BOX
%================================
\makeatletter
\newtcbtheorem[number within=chapter]{Theorem}{Theorem}{enhanced,
    breakable,
    colback=mytheoremcolor!5,
    colframe=mytheoremcolor,
    attach boxed title to top left={yshift*=-\tcboxedtitleheight},
    fonttitle=\bfseries,
    title={#2},
    boxed title size=title,
    boxed title style={%
        sharp corners,
        rounded corners=northwest,
        colback=tcbcolframe,
        boxrule=0pt,
    },
    underlay boxed title={%
        \path[fill=tcbcolframe] (title.south west)--(title.south east)
        to[out=0, in=180] ([xshift=5mm]title.east)--
        (title.center-|frame.east)
        [rounded corners=\kvtcb@arc] |-
        (frame.north) -| cycle;
    },
    #1
}{theorem}
\makeatother

\newenvironment{theorem}[2][]{%
    \begin{Theorem}{#2}{#1}%
    }{%
    \end{Theorem}%
}

%================================
% DEFINITION BOX
%================================
\makeatletter
\newtcbtheorem[number
within=chapter]{Definition}{Definition}{enhanced,
    breakable,
    colback=mydefinitioncolor!5,
    colframe=mydefinitioncolor,
    attach boxed title to top left={yshift*=-\tcboxedtitleheight},
    fonttitle=\bfseries,
    title={#2},
    boxed title size=title,
    boxed title style={%
        sharp corners,
        rounded corners=northwest,
        colback=tcbcolframe,
        boxrule=0pt,
    },
    underlay boxed title={%
        \path[fill=tcbcolframe] (title.south west)--(title.south east)
        to[out=0, in=180] ([xshift=5mm]title.east)--
        (title.center-|frame.east)
        [rounded corners=\kvtcb@arc] |-
        (frame.north) -| cycle;
    },
    #1
}{definition}
\makeatother

\newenvironment{definition}[2][]{%
    \begin{Definition}{#2}{#1}%
    }{%
    \end{Definition}%
}

%================================
% PROBLEM BOX
%================================
\newtcbtheorem[number within=chapter]{Problem}{Problem}
{%
    enhanced,
    breakable,
    colback = myproblemcolor!10,
    frame hidden,
    boxrule = 0sp,
    borderline west = {2pt}{0pt}{myproblemcolor},
    sharp corners,
    detach title,
    before upper = \tcbtitle\par\smallskip,
    coltitle = myproblemcolor!85!black,
    fonttitle = \bfseries\sffamily,
    description font = \mdseries,
    separator sign none,
    segmentation style={solid, myproblemcolor!85!black},
}
{problem}

\newenvironment{problem}[2][]{%
    \begin{Problem}{#2}{#1}%
    }{%
    \end{Problem}%
}
%================================
% CLAIM BOX
%================================
\newtcbtheorem[number within=chapter]{claim}{Claim}
{%
    enhanced
    ,breakable
    ,colback = myclaimcolor!10
    ,frame hidden
    ,boxrule = 0sp
    ,borderline west = {2pt}{0pt}{myclaimcolor}
    ,sharp corners
    ,detach title
    ,before upper = \tcbtitle\par\smallskip
    ,coltitle = myclaimcolor!85!black
    ,fonttitle = \bfseries\sffamily
    ,description font = \mdseries
    ,separator sign none
    ,segmentation style={solid, myclaimcolor!85!black}
}
{claim}

%================================
% NOTE BOX
%================================

\newtcbtheorem[number within=chapter]{note}{Note}
{%
    enhanced
    ,breakable
    ,colback = mynotecolor!10
    ,frame hidden
    ,boxrule = 0sp
    ,borderline west = {2pt}{0pt}{mynotecolor}
    ,sharp corners
    ,detach title
    ,before upper = \tcbtitle\par\smallskip
    ,coltitle = mynotecolor!85!black
    ,fonttitle = \bfseries\sffamily
    ,description font = \mdseries
    ,separator sign none
    ,segmentation style={solid, mynotecolor!85!black}
}
{th}
%================================
% QUOTE BOX
%================================
\newtcolorbox{refbox}[1][]{%
enhanced,
breakable,
colback = myquotecolor!10,
frame hidden,
boxrule = 0sp,
borderline west = {2pt}{0pt}{myquotecolor},
sharp corners,
#1
}
\renewenvironment{quote}{%
\begin{refbox}}{%
\end{refbox}}
% Extra Information
% INFO: Use \mathclap and \substack to create multiline